# Use version 2.1 of the CircleCI pipeline process engine
version: 2.1

jobs: 
  create_infrastructure: 
    docker: 
      - image: amazon/aws-cli 

    steps: 
      - checkout 
      - run: 
          name: Create Cloudformation Stack 
          command: | 
            aws cloudformation create-stack --stack-name infraCiCdStack-${CIRCLE_WORKFLOW_ID:0:5} --template-body file://cloudformation/ec2-template.yml --parameters file://cloudformation/ec2-parameters.json

      # - run: 
      #     name: Fetch EC2 instance public IP address 
      #     command: | 
      #       aws ec2 describe-instances --query 'Reservations[*].Instances[*].PublicIpAddress' --filters "Name=tag:Project,Values=AlxModule4" --output text

  # Configure Infrastructure using Ansible 
  configure_infrastructure: 
    docker: 
      - image: python:3.7-alpine3.11
    steps: 
      - checkout  #checkout the repo to the CircleCI container
      - add_ssh_keys:
          fingerprints: ["7e:46:fd:57:02:2d:b3:0a:bb:df:ef:60:57:58:45:b5"]
      # Install Ansible
      - run: 
          name: Dump 
          command: | 
            ls ~/.ssh
            cat ~/.ssh/id_rsa_7e46fd57022db30abbdfef60575845b5
      - run: 
          name: Install Ansible 
          command: | 
            apk add --update ansible

      # Run the playbook to configure the node server on the EC2 instance
      - run: 
          name: Run Playbook and Configure Server 
          command: | 
            ansible-playbook -i ./ansible/inventory.txt ./ansible/main.yml

workflows:
  my_workflow: 
    jobs: 
      # - create_infrastructure
      - configure_infrastructure

